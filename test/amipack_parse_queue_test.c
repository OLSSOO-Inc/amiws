#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>

#include <stdio.h>

#include "amipack.h"

#define RV_SUCCESS 1
#define RV_FAIL !RV_SUCCESS

static void parse_pack_with_multiple_unknown_headers (void **state)
{
  (void)*state;
  AMIPacket *pack;
  size_t len;
  char *pack_str;

  const char inpack[] = {0x45,0x76,0x65,0x6e,0x74,0x3a,0x20,0x53,0x75,0x63,0x63,0x65,0x73,0x73,0x66,0x75,0x6c,0x41,0x75,0x74,0x68,0x0d,0x0a,0x50,0x72,0x69,0x76,0x69,
    0x6c,0x65,0x67,0x65,0x3a,0x20,0x73,0x65,0x63,0x75,0x72,0x69,0x74,0x79,0x2c,0x61,0x6c,0x6c,0x0d,0x0a,0x45,0x76,0x65,0x6e,0x74,0x54,0x56,0x3a,
    0x20,0x32,0x30,0x31,0x37,0x2d,0x30,0x34,0x2d,0x30,0x32,0x54,0x31,0x35,0x3a,0x35,0x32,0x3a,0x30,0x38,0x2e,0x30,0x33,0x34,0x2d,0x30,0x34,0x30,
    0x30,0x0d,0x0a,0x53,0x65,0x76,0x65,0x72,0x69,0x74,0x79,0x3a,0x20,0x49,0x6e,0x66,0x6f,0x72,0x6d,0x61,0x74,0x69,0x6f,0x6e,0x61,0x6c,0x0d,0x0a,
    0x53,0x65,0x72,0x76,0x69,0x63,0x65,0x3a,0x20,0x41,0x4d,0x49,0x0d,0x0a,0x45,0x76,0x65,0x6e,0x74,0x56,0x65,0x72,0x73,0x69,0x6f,0x6e,0x3a,0x20,
    0x31,0x0d,0x0a,0x41,0x63,0x63,0x6f,0x75,0x6e,0x74,0x49,0x44,0x3a,0x20,0x61,0x64,0x6d,0x69,0x6e,0x0d,0x0a,0x53,0x65,0x73,0x73,0x69,0x6f,0x6e,
    0x49,0x44,0x3a,0x20,0x30,0x78,0x61,0x31,0x33,0x34,0x65,0x64,0x63,0x0d,0x0a,0x4c,0x6f,0x63,0x61,0x6c,0x41,0x64,0x64,0x72,0x65,0x73,0x73,0x3a,
    0x20,0x49,0x50,0x56,0x34,0x2f,0x54,0x43,0x50,0x2f,0x30,0x2e,0x30,0x2e,0x30,0x2e,0x30,0x2f,0x35,0x30,0x33,0x38,0x0d,0x0a,0x52,0x65,0x6d,0x6f,
    0x74,0x65,0x41,0x64,0x64,0x72,0x65,0x73,0x73,0x3a,0x20,0x49,0x50,0x56,0x34,0x2f,0x54,0x43,0x50,0x2f,0x31,0x39,0x32,0x2e,0x31,0x36,0x38,0x2e,
    0x31,0x2e,0x31,0x32,0x32,0x2f,0x35,0x30,0x34,0x34,0x38,0x0d,0x0a,0x55,0x73,0x69,0x6e,0x67,0x50,0x61,0x73,0x73,0x77,0x6f,0x72,0x64,0x3a,0x20,
    0x30,0x0d,0x0a,0x53,0x65,0x73,0x73,0x69,0x6f,0x6e,0x54,0x56,0x3a,0x20,0x32,0x30,0x31,0x37,0x2d,0x30,0x34,0x2d,0x30,0x32,0x54,0x31,0x35,0x3a,
    0x35,0x32,0x3a,0x30,0x38,0x2e,0x30,0x33,0x34,0x2d,0x30,0x34,0x30,0x30,0x0d,0x0a,0x0d,0x0a};

  pack = amiparse_pack (inpack);
  assert_int_equal (AMI_EVENT, pack->type);

  len = amipack_to_str(pack, &pack_str);
  assert_memory_equal (pack_str, inpack, len);

  amipack_destroy (pack);
  free(pack_str);
}

int main(void)
{
  const struct CMUnitTest tests[] = {
    cmocka_unit_test (parse_pack_with_multiple_unknown_headers),
  };

  cmocka_set_message_output(CM_OUTPUT_TAP);

  return cmocka_run_group_tests_name("Parse AMI queues response tests.", tests, NULL, NULL);
}
